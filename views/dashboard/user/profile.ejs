<% title = 'Profile | CampusConnect' %> <% userRole = typeof user !==
'undefined' ? user.role : 'user' %> <% const body = `
<div class="max-w-4xl mx-auto">
  <!-- Profile Header -->
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <!-- Profile Picture -->
        <div class="relative">
          <img
            src="${user.profilePicture || '/assets/default-avatar.png'}"
            alt="Profile Picture"
            class="w-20 h-20 rounded-full border-4 border-white shadow-lg object-cover"
            id="profilePicture" />
          <button
            id="uploadPictureBtn"
            class="absolute bottom-0 right-0 bg-blue-600 hover:bg-blue-700 text-white rounded-full p-1.5 shadow-lg transition duration-200"
            title="Upload new picture">
            <i class="fas fa-camera text-xs"></i>
          </button>
        </div>
        <div class="ml-6">
          <h1 class="text-2xl font-bold text-gray-900">
            ${user.firstName} ${user.lastName}
          </h1>
          <p class="text-gray-600">${user.faculty || 'Faculty Information'}</p>
          <p class="text-sm text-gray-500">${user.email}</p>
          <p class="text-sm text-gray-500 capitalize">Role: ${user.role}</p>
        </div>
      </div>
      <div class="flex space-x-3">
        <button
          id="editProfileBtn"
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200">
          <i class="fas fa-edit mr-2"></i>Edit Profile
        </button>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="bg-white rounded-lg shadow p-6 text-center">
      <div class="text-3xl font-bold text-blue-600">${joinedClubsCount}</div>
      <div class="text-gray-600">Clubs Joined</div>
    </div>
    <div class="bg-white rounded-lg shadow p-6 text-center">
      <div class="text-3xl font-bold text-green-600">${userPostsCount}</div>
      <div class="text-gray-600">Posts Created</div>
    </div>
    <div class="bg-white rounded-lg shadow p-6 text-center">
      <div class="text-3xl font-bold text-purple-600">
        ${user.createdAt ? new Date(user.createdAt).getFullYear() : '2024'}
      </div>
      <div class="text-gray-600">Member Since</div>
    </div>
  </div>

  <!-- Joined Clubs Section -->
  <div class="bg-white rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold text-gray-900 mb-4">Clubs You're In</h2>
    <div id="joinedClubsList">
      <!-- Clubs will be populated by JavaScript -->
      <div class="flex justify-center py-8">
        <div
          class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        <span class="ml-2 text-gray-600">Loading clubs...</span>
      </div>
    </div>
  </div>
</div>

<!-- Edit Profile Modal -->
<div
  id="editProfileModal"
  class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
  <div
    class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900">Edit Profile</h3>
        <button id="closeEditModal" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="editProfileForm" class="space-y-4">
        <div>
          <label
            for="editFirstName"
            class="block text-sm font-medium text-gray-700"
            >First Name</label
          >
          <input
            type="text"
            id="editFirstName"
            name="firstName"
            required
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
        </div>
        <div>
          <label
            for="editLastName"
            class="block text-sm font-medium text-gray-700"
            >Last Name</label
          >
          <input
            type="text"
            id="editLastName"
            name="lastName"
            required
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
        </div>
        <div>
          <label
            for="editFaculty"
            class="block text-sm font-medium text-gray-700"
            >Faculty</label
          >
          <input
            type="text"
            id="editFaculty"
            name="faculty"
            required
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
        </div>
        <div>
          <label for="editPhone" class="block text-sm font-medium text-gray-700"
            >Phone</label
          >
          <input
            type="tel"
            id="editPhone"
            name="phone"
            required
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
        </div>
        <div class="flex justify-end space-x-3">
          <button
            type="button"
            id="cancelEdit"
            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            Cancel
          </button>
          <button
            type="submit"
            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Hidden file input for profile picture upload -->
<input type="file" id="profilePictureInput" accept="image/*" class="hidden" />

<script>
  // Load user's joined clubs
  async function loadJoinedClubs() {
    try {
      const token = sessionStorage.getItem("token");
      const response = await fetch("/api/users/clubs/joined", {
        headers: {
          Authorization: "Bearer " + token,
          "Content-Type": "application/json",
        },
      });

      if (!response.ok) throw new Error("Failed to fetch clubs");

      const data = await response.json();
      const container = document.getElementById("joinedClubsList");

      if (data.clubs && data.clubs.length > 0) {
        container.innerHTML =
          '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
        data.clubs.forEach((club) => {
          const clubCard = document.createElement("div");
          clubCard.className =
            "border rounded-lg p-4 hover:bg-gray-50 transition duration-200";
          clubCard.innerHTML =
            '<div class="flex items-start justify-between">' +
            '<div class="flex items-start space-x-3">' +
            '<img src="' +
            (club.logo || "/assets/default-club.png") +
            '" alt="' +
            club.name +
            '" class="w-12 h-12 rounded-lg object-cover">' +
            "<div>" +
            '<h3 class="font-semibold text-gray-900">' +
            club.name +
            "</h3>" +
            '<p class="text-sm text-gray-600 line-clamp-2">' +
            club.description +
            "</p>" +
            '<div class="flex items-center mt-2">' +
            '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">' +
            club.category +
            "</span>" +
            '<span class="ml-2 text-sm text-gray-500">' +
            '<i class="fas fa-users mr-1"></i>' +
            (club.memberCount || 0) +
            " members" +
            "</span>" +
            "</div>" +
            "</div>" +
            "</div>" +
            "<button onclick=\"leaveClub('" +
            club._id +
            '\')" class="text-red-600 hover:text-red-800 text-sm font-medium">' +
            '<i class="fas fa-sign-out-alt mr-1"></i>Leave' +
            "</button>" +
            "</div>";
          container.appendChild(clubCard);
        });
        container.innerHTML += "</div>";
      } else {
        container.innerHTML =
          '<div class="text-center py-12">' +
          '<i class="fas fa-users text-6xl text-gray-300 mb-4"></i>' +
          '<h3 class="text-lg font-medium text-gray-900 mb-2">No clubs joined yet</h3>' +
          '<p class="text-gray-500 mb-4">Start exploring and join clubs that interest you!</p>' +
          '<a href="/api/users/clubs" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200">' +
          '<i class="fas fa-search mr-2"></i>Browse Clubs' +
          "</a>" +
          "</div>";
      }
    } catch (error) {
      console.error("Error loading clubs:", error);
      document.getElementById("joinedClubsList").innerHTML =
        '<div class="text-center py-8">' +
        '<p class="text-red-500">Error loading clubs. Please try again.</p>' +
        "</div>";
    }
  }

  // Leave club function
  async function leaveClub(clubId) {
    if (confirm("Are you sure you want to leave this club?")) {
      try {
        const token = sessionStorage.getItem("token");
        const response = await fetch("/api/users/clubs/" + clubId + "/leave", {
          method: "DELETE",
          headers: {
            Authorization: "Bearer " + token,
            "Content-Type": "application/json",
          },
        });

        if (response.ok) {
          alert("Successfully left the club.");
          loadJoinedClubs(); // Reload the list
        } else {
          const errorData = await response.json();
          alert("Error: " + errorData.error);
        }
      } catch (error) {
        console.error("Error leaving club:", error);
        alert("An error occurred while trying to leave the club.");
      }
    }
  }

  // Profile picture upload
  document
    .getElementById("uploadPictureBtn")
    .addEventListener("click", function () {
      document.getElementById("profilePictureInput").click();
    });

  document
    .getElementById("profilePictureInput")
    .addEventListener("change", async function (e) {
      const file = e.target.files[0];
      if (!file) return;

      // Validate file type
      if (!file.type.startsWith("image/")) {
        alert("Please select an image file.");
        return;
      }

      // Validate file size (5MB max)
      if (file.size > 5 * 1024 * 1024) {
        alert("File size must be less than 5MB.");
        return;
      }

      const formData = new FormData();
      formData.append("profilePicture", file);

      try {
        const token = sessionStorage.getItem("token");
        const response = await fetch("/api/users/upload-profile-picture", {
          method: "POST",
          headers: {
            Authorization: "Bearer " + token,
          },
          body: formData,
        });

        if (response.ok) {
          const data = await response.json();
          document.getElementById("profilePicture").src =
            data.user.profilePicture;
          alert("Profile picture updated successfully!");
        } else {
          const errorData = await response.json();
          alert("Error: " + errorData.error);
        }
      } catch (error) {
        console.error("Error uploading picture:", error);
        alert("An error occurred while uploading the picture.");
      }
    });

  // Load clubs when page loads
  document.addEventListener("DOMContentLoaded", function () {
    loadJoinedClubs();

    // Edit profile modal
    const editProfileModal = document.getElementById("editProfileModal");
    const editProfileForm = document.getElementById("editProfileForm");

    document
      .getElementById("editProfileBtn")
      .addEventListener("click", function () {
        // Populate form with current user data
        document.getElementById("editFirstName").value = "${user.firstName}";
        document.getElementById("editLastName").value = "${user.lastName}";
        document.getElementById("editFaculty").value = "${user.faculty}";
        document.getElementById("editPhone").value = "${user.phone}";
        editProfileModal.classList.remove("hidden");
      });

    document
      .getElementById("closeEditModal")
      .addEventListener("click", function () {
        editProfileModal.classList.add("hidden");
      });

    document
      .getElementById("cancelEdit")
      .addEventListener("click", function () {
        editProfileModal.classList.add("hidden");
      });

    editProfileForm.addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(editProfileForm);
      const data = {
        firstName: formData.get("firstName"),
        lastName: formData.get("lastName"),
        faculty: formData.get("faculty"),
        phone: formData.get("phone"),
      };

      try {
        const token = sessionStorage.getItem("token");
        const response = await fetch("/api/users/profile", {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          const result = await response.json();
          alert("Profile updated successfully!");
          editProfileModal.classList.add("hidden");
          // Reload the page to reflect changes
          location.reload();
        } else {
          const errorData = await response.json();
          alert("Error: " + errorData.error);
        }
      } catch (error) {
        console.error("Error updating profile:", error);
        alert("An error occurred while updating the profile.");
      }
    });
  });
</script>
`%> <%- include('../layout', { title: title, userRole: userRole, body: body })
%>
