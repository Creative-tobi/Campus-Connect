<% title = 'Profile | CampusConnect' %> <% userRole = typeof user !==
'undefined' ? user.role : 'user' %> <% const body = `
<div class="max-w-4xl mx-auto">
  <!-- Profile Header -->
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <!-- Profile Picture -->
        <div class="relative">
          <img
            src="${user.profilePicture || '/assets/default-avatar.png'}"
            alt="Profile Picture"
            class="w-20 h-20 rounded-full border-4 border-white shadow-lg object-cover"
            id="profilePicture" />
          <button
            id="uploadPictureBtn"
            class="absolute bottom-0 right-0 bg-blue-600 hover:bg-blue-700 text-white rounded-full p-1.5 shadow-lg transition duration-200"
            title="Upload new picture">
            <i class="fas fa-camera text-xs"></i>
          </button>
        </div>
        <div class="ml-6">
          <h1 class="text-2xl font-bold text-gray-900">
            ${user.firstName} ${user.lastName}
          </h1>
          <p class="text-gray-600">${user.faculty || 'Faculty Information'}</p>
          <p class="text-sm text-gray-500">${user.email}</p>
          <p class="text-sm text-gray-500 capitalize">Role: ${user.role}</p>
        </div>
      </div>
      <div class="flex space-x-3">
        <button
          id="editProfileBtn"
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200">
          <i class="fas fa-edit mr-2"></i>Edit Profile
        </button>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="bg-white rounded-lg shadow p-6 text-center">
      <div class="text-3xl font-bold text-blue-600">${joinedClubsCount}</div>
      <div class="text-gray-600">Clubs Joined</div>
    </div>
    <div class="bg-white rounded-lg shadow p-6 text-center">
      <div class="text-3xl font-bold text-green-600">${userPostsCount}</div>
      <div class="text-gray-600">Posts Created</div>
    </div>
    <div class="bg-white rounded-lg shadow p-6 text-center">
      <div class="text-3xl font-bold text-purple-600">
        ${user.createdAt ? new Date(user.createdAt).getFullYear() : '2024'}
      </div>
      <div class="text-gray-600">Member Since</div>
    </div>
  </div>

  <!-- Joined Clubs Section -->
  <div class="bg-white rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold text-gray-900 mb-4">Clubs You're In</h2>
    <div id="joinedClubsList">
      <!-- Clubs will be populated by JavaScript -->
      <div class="flex justify-center py-8">
        <div
          class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        <span class="ml-2 text-gray-600">Loading clubs...</span>
      </div>
    </div>
  </div>
</div>

<!-- Hidden file input for profile picture upload -->
<input type="file" id="profilePictureInput" accept="image/*" class="hidden" />

<script>
  // Load user's joined clubs
  async function loadJoinedClubs() {
    try {
      const token = sessionStorage.getItem("token");
      const response = await fetch("/api/users/clubs/joined", {
        headers: {
          Authorization: "Bearer " + token,
          "Content-Type": "application/json",
        },
      });

      if (!response.ok) throw new Error("Failed to fetch clubs");

      const data = await response.json();
      const container = document.getElementById("joinedClubsList");

      if (data.clubs && data.clubs.length > 0) {
        container.innerHTML =
          '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
        data.clubs.forEach((club) => {
          const clubCard = document.createElement("div");
          clubCard.className =
            "border rounded-lg p-4 hover:bg-gray-50 transition duration-200";
          clubCard.innerHTML = `
            <div class="flex items-start justify-between">
              <div class="flex items-start space-x-3">
                <img src="${club.logo || "/assets/default-club.png"}" alt="${
            club.name
          }" class="w-12 h-12 rounded-lg object-cover">
                <div>
                  <h3 class="font-semibold text-gray-900">${club.name}</h3>
                  <p class="text-sm text-gray-600 line-clamp-2">${
                    club.description
                  }</p>
                  <div class="flex items-center mt-2">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                      ${club.category}
                    </span>
                    <span class="ml-2 text-sm text-gray-500">
                      <i class="fas fa-users mr-1"></i>${
                        club.memberCount || 0
                      } members
                    </span>
                  </div>
                </div>
              </div>
              <button onclick="leaveClub('${
                club._id
              }')" class="text-red-600 hover:text-red-800 text-sm font-medium">
                <i class="fas fa-sign-out-alt mr-1"></i>Leave
              </button>
            </div>
          `;
          container.appendChild(clubCard);
        });
        container.innerHTML += "</div>";
      } else {
        container.innerHTML = `
          <div class="text-center py-12">
            <i class="fas fa-users text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No clubs joined yet</h3>
            <p class="text-gray-500 mb-4">Start exploring and join clubs that interest you!</p>
            <a href="/api/users/clubs" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200">
              <i class="fas fa-search mr-2"></i>Browse Clubs
            </a>
          </div>
        `;
      }
    } catch (error) {
      console.error("Error loading clubs:", error);
      document.getElementById("joinedClubsList").innerHTML = `
        <div class="text-center py-8">
          <p class="text-red-500">Error loading clubs. Please try again.</p>
        </div>
      `;
    }
  }

  // Leave club function
  async function leaveClub(clubId) {
    if (confirm("Are you sure you want to leave this club?")) {
      try {
        const token = sessionStorage.getItem("token");
        const response = await fetch(`/api/users/clubs/${clubId}/leave`, {
          method: "DELETE",
          headers: {
            Authorization: "Bearer " + token,
            "Content-Type": "application/json",
          },
        });

        if (response.ok) {
          alert("Successfully left the club.");
          loadJoinedClubs(); // Reload the list
        } else {
          const errorData = await response.json();
          alert("Error: " + errorData.error);
        }
      } catch (error) {
        console.error("Error leaving club:", error);
        alert("An error occurred while trying to leave the club.");
      }
    }
  }

  // Profile picture upload
  document
    .getElementById("uploadPictureBtn")
    .addEventListener("click", function () {
      document.getElementById("profilePictureInput").click();
    });

  document
    .getElementById("profilePictureInput")
    .addEventListener("change", async function (e) {
      const file = e.target.files[0];
      if (!file) return;

      // Validate file type
      if (!file.type.startsWith("image/")) {
        alert("Please select an image file.");
        return;
      }

      // Validate file size (5MB max)
      if (file.size > 5 * 1024 * 1024) {
        alert("File size must be less than 5MB.");
        return;
      }

      const formData = new FormData();
      formData.append("profilePicture", file);

      try {
        const token = sessionStorage.getItem("token");
        const response = await fetch("/api/users/upload-profile-picture", {
          method: "POST",
          headers: {
            Authorization: "Bearer " + token,
          },
          body: formData,
        });

        if (response.ok) {
          const data = await response.json();
          document.getElementById("profilePicture").src =
            data.user.profilePicture;
          alert("Profile picture updated successfully!");
        } else {
          const errorData = await response.json();
          alert("Error: " + errorData.error);
        }
      } catch (error) {
        console.error("Error uploading picture:", error);
        alert("An error occurred while uploading the picture.");
      }
    });

  // Edit profile button (placeholder)
  document
    .getElementById("editProfileBtn")
    .addEventListener("click", function () {
      alert("Profile editing feature coming soon!");
    });

  // Load clubs when page loads
  document.addEventListener("DOMContentLoaded", loadJoinedClubs);
</script>
`%> <%- include('../layout', { title: title, userRole: userRole, body: body })
%>
