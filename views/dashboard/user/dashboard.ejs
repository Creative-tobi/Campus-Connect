<!-- This file uses the layout.ejs -->
<% title = 'User Dashboard | CampusConnect' %> <% userRole = typeof user !==
'undefined' ? user.role : 'user' %> <% const userData = typeof user !==
'undefined' ? user : (typeof window !== 'undefined' ?
JSON.parse(sessionStorage.getItem('user')) : null); %> <% const body = `
<div class="max-w-4xl mx-auto">
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-xl font-bold text-gray-900">
          Welcome back, ${userData ? userData.firstName : 'User'}!
        </h1>
        <p class="text-gray-600">Here's what's happening in your clubs.</p>
      </div>
      <a
        href="/api/clubs/create"
        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
        Create Club
      </a>
    </div>
  </div>

  <!-- Example Post Input -->
  <div class="bg-white rounded-lg shadow p-4 mb-6">
    <div class="flex items-center mb-4">
      ` + (userData && userData.profilePicture ? `<img
        src="${userData.profilePicture}"
        alt="Your Profile"
        class="w-10 h-10 rounded-full object-cover mr-3" />` : `
      <div
        class="bg-gray-200 border-2 border-dashed rounded-full w-10 h-10 mr-3 flex items-center justify-center">
        <span class="text-gray-500 text-sm"
          >${userData ? userData.firstName.charAt(0) : 'U'}</span
        >
      </div>
      `) + `
      <input
        type="text"
        placeholder="Start a post..."
        class="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm focus:outline-none"
        readonly />
    </div>
    <div class="flex justify-between">
      <button
        class="flex items-center text-gray-500 hover:text-gray-700"
        disabled>
        <i class="fas fa-image text-blue-500 mr-1"></i> Photo
      </button>
      <button
        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium"
        disabled>
        Post
      </button>
    </div>
  </div>

  <!-- Club Posts Feed -->
  <div id="clubPostsFeed">
    <p class="text-gray-500 text-center py-4">Loading posts...</p>
  </div>
</div>

<script>
  // Example: Fetch user's club posts
  async function loadClubPosts() {
    console.log(sessionStorage.getItem("token"));

    try {
      const pro = await fetch("/api/users/dashboard", {
        headers: {
          Authorization: "Bearer " + sessionStorage.getItem("token"),
        },
      });
      // This fetches posts from clubs the user is a member of
      const response = await fetch("/api/users/posts", {
        // Adjust route if necessary, e.g., /api/posts/my-clubs
        headers: {
          Authorization: "Bearer " + sessionStorage.getItem("token"),
        },
      });
      if (!response.ok) throw new Error("Failed to fetch posts");
      const data = await response.json();
      const container = document.getElementById("clubPostsFeed");
      container.innerHTML = ""; // Clear loading message

      if (data.posts && data.posts.length > 0) {
        data.posts.forEach((post) => {
          const postDiv = document.createElement("div");
          postDiv.className = "bg-white rounded-lg shadow p-6 mb-6";
          postDiv.innerHTML =
            '<div class="flex items-start">' +
            "<!-- Author Profile Picture -->" +
            (post.author.profilePicture
              ? '<img src="' +
                post.author.profilePicture +
                '" alt="' +
                post.author.name +
                '" class="w-12 h-12 rounded-full object-cover mr-3">'
              : '<div class="bg-gray-200 border-2 border-dashed rounded-full w-12 h-12 mr-3 flex items-center justify-center"><span class="text-gray-500 text-sm">' +
                post.author.name.charAt(0) +
                "</span></div>") +
            '<div class="flex-1">' +
            '<h2 class="font-semibold text-gray-900">' +
            post.author.name +
            "</h2>" +
            '<p class="text-xs text-gray-500">' +
            post.club.name +
            " | " +
            new Date(post.createdAt).toLocaleString() +
            "</p>" +
            "</div>" +
            "</div>" +
            '<div class="mt-4">' +
            '<h3 class="font-medium text-gray-900">' +
            post.title +
            "</h3>" +
            '<p class="text-gray-800 mt-1">' +
            post.content +
            "</p>" +
            (post.media
              ? '<div class="mt-2 bg-gray-200 border-2 border-dashed rounded-xl w-full h-64 bg-cover bg-center" style="background-image: url(' +
                post.media +
                ');"></div>'
              : "") +
            "</div>" +
            '<div class="mt-4 flex space-x-4 text-gray-500">' +
            '<button class="flex items-center hover:text-gray-700">' +
            '<i class="far fa-thumbs-up mr-1"></i> Like' +
            "</button>" +
            '<button class="flex items-center hover:text-gray-700">' +
            '<i class="far fa-comment mr-1"></i> Comment' +
            "</button>" +
            '<button class="flex items-center hover:text-gray-700">' +
            '<i class="fas fa-share mr-1"></i> Share' +
            "</button>" +
            "</div>";
          container.appendChild(postDiv);
        });
      } else {
        container.innerHTML =
          '<div class="bg-white rounded-lg shadow p-6 text-center"><p class="text-gray-500">No posts found in your clubs.</p></div>';
      }
    } catch (error) {
      console.error("Error loading posts:", error);
      document.getElementById("clubPostsFeed").innerHTML =
        '<div class="bg-white rounded-lg shadow p-6 text-center"><p class="text-red-500">Error loading posts.</p></div>';
    }
  }

  // Load posts when page loads
  document.addEventListener("DOMContentLoaded", loadClubPosts);
</script>
`%> <%- include('../layout', { title: title, userRole: userRole, body: body })
%>
