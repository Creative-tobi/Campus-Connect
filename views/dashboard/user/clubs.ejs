<!-- This file uses the layout.ejs -->
<% userRole = typeof user !== 'undefined' ? user.role : 'user' %> <% const
pageTitle = typeof user !== 'undefined' ? 'My Clubs' : 'Explore Clubs' %> <%
const pageDescription = typeof user !== 'undefined' ? 'Clubs you\'re a member
of.' : 'Discover and join clubs that interest you.' %> <% const body = `
<div class="max-w-6xl mx-auto">
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <h1 class="text-xl font-bold text-gray-900" id="pageTitle">
      ` + pageTitle + `
    </h1>
    <p class="text-gray-600" id="pageDescription">` + pageDescription + `</p>
  </div>

  <!-- Search and Filter -->
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="flex flex-wrap gap-4">
      <div class="flex-1 min-w-0">
        <input
          type="text"
          id="searchInput"
          placeholder="Search clubs..."
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
      <div class="w-48">
        <select
          id="categoryFilter"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">All Categories</option>
          <option value="academic">Academic</option>
          <option value="sports">Sports</option>
          <option value="tech">Technology</option>
          <option value="arts">Arts</option>
          <option value="cultural">Cultural</option>
          <option value="political">Political</option>
          <option value="other">Other</option>
        </select>
      </div>
      <button
        id="searchBtn"
        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
        Search
      </button>
    </div>
  </div>

  <!-- Clubs List -->
  <div class="bg-white rounded-lg shadow p-6">
    <div
      id="clubsContainer"
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Clubs will be populated by JavaScript -->
      <div class="text-center text-gray-500 py-8">Loading clubs...</div>
    </div>

    <!-- Pagination -->
    <div id="paginationContainer" class="mt-6 flex justify-center">
      <!-- Pagination will be populated by JavaScript -->
    </div>
  </div>
</div>

<!-- Modal for Club Details -->
<div
  id="clubModal"
  class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
  <div
    class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900" id="modalTitle">
          Club Details
        </h3>
        <button
          onclick="closeModal()"
          class="text-gray-400 hover:text-gray-600">
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div id="modalContent" class="text-sm text-gray-500">
        <!-- Club details will be populated here -->
      </div>
    </div>
  </div>
</div>

<script>
  let currentPage = 1;
  let currentSearch = "";
  let currentCategory = "";
  let clubId = '<%= typeof club !== "undefined" && club ? club._id : "" %>';

  async function loadClubs(page = 1, search = "", category = "") {
    try {
      const params = new URLSearchParams({
        page: page,
        limit: 9, // 3x3 grid
        ...(search && { search }),
        ...(category && { category }),
      });

      const response = await fetch("/api/clubs?" + params, {
        headers: {
          Accept: "application/json",
        },
      });

      if (!response.ok) throw new Error("Failed to fetch clubs");

      const data = await response.json();
      console.log("Clubs data:", data.clubs);
      const container = document.getElementById("clubsContainer");
      container.innerHTML = "";

      if (data.clubs && data.clubs.length > 0) {
        data.clubs.forEach((club) => {
          const clubCard = document.createElement("div");
          clubCard.className =
            "bg-gray-50 rounded-lg p-4 hover:shadow-md transition-shadow";
          clubCard.innerHTML =
            '<div class="flex items-start space-x-4">' +
            '<div class="w-16 h-16 bg-gray-200 rounded-lg flex-shrink-0">' +
            (club.logo
              ? '<img src="' +
                club.logo +
                '" alt="' +
                club.name +
                '" class="w-full h-full object-cover rounded-lg">'
              : '<div class="w-full h-full bg-gray-300 rounded-lg"></div>') +
            "</div>" +
            '<div class="flex-1 min-w-0">' +
            '<h3 class="text-lg font-semibold text-gray-900 truncate">' +
            club.name +
            "</h3>" +
            '<p class="text-sm text-gray-600 mb-2">' +
            club.description.substring(0, 100) +
            "...</p>" +
            '<div class="flex items-center justify-between">' +
            '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">' +
            club.category +
            "</span>" +
            '<span class="text-sm text-gray-500">' +
            club.memberCount +
            " members</span>" +
            "</div>" +
            '<div class="mt-3 flex space-x-2">' +
            "<button onclick=\"viewClubDetails('" +
            club._id +
            '\')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">View Details</button>' +
            "<button onclick=\"joinClub('" +
            club._id +
            '\')" class="text-green-600 hover:text-green-800 text-sm font-medium">Join Club</button>' +
            "</div>" +
            "</div>" +
            "</div>";
          container.appendChild(clubCard);
        });
      } else {
        container.innerHTML =
          '<div class="col-span-full text-center text-gray-500 py-8">No clubs found.</div>';
      }

      // Update pagination
      updatePagination(data.pagination);
    } catch (error) {
      console.error("Error loading clubs:", error);
      document.getElementById("clubsContainer").innerHTML =
        '<div class="col-span-full text-center text-red-500 py-8">Error loading clubs.</div>';
    }
  }

  function updatePagination(pagination) {
    const container = document.getElementById("paginationContainer");
    if (!pagination || pagination.pages <= 1) {
      container.innerHTML = "";
      return;
    }

    let html =
      '<nav class="flex items-center justify-between px-4 py-3 bg-white border-t border-gray-200 sm:px-6 rounded-lg">';
    html += '<div class="flex justify-between flex-1 sm:hidden">';
    if (pagination.current > 1) {
      html +=
        '<a href="#" onclick="changePage(' +
        (pagination.current - 1) +
        ')" class="relative inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Previous</a>';
    }
    if (pagination.current < pagination.pages) {
      html +=
        '<a href="#" onclick="changePage(' +
        (pagination.current + 1) +
        ')" class="relative ml-3 inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Next</a>';
    }
    html += "</div>";

    html +=
      '<div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">';
    html +=
      '<div><p class="text-sm text-gray-700">Showing page <span class="font-medium">' +
      pagination.current +
      '</span> of <span class="font-medium">' +
      pagination.pages +
      "</span></p></div>";
    html +=
      '<div><nav class="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">';

    // Previous button
    if (pagination.current > 1) {
      html +=
        '<a href="#" onclick="changePage(' +
        (pagination.current - 1) +
        ')" class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0"><span class="sr-only">Previous</span><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" /></svg></a>';
    }

    // Page numbers
    for (
      let i = Math.max(1, pagination.current - 2);
      i <= Math.min(pagination.pages, pagination.current + 2);
      i++
    ) {
      const isActive = i === pagination.current;
      html +=
        '<a href="#" onclick="changePage(' +
        i +
        ')" class="relative inline-flex items-center px-4 py-2 text-sm font-semibold ' +
        (isActive
          ? "bg-blue-600 text-white focus:z-20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600"
          : "text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0") +
        '">' +
        i +
        "</a>";
    }

    // Next button
    if (pagination.current < pagination.pages) {
      html +=
        '<a href="#" onclick="changePage(' +
        (pagination.current + 1) +
        ')" class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0"><span class="sr-only">Next</span><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l4.5-4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg></a>';
    }

    html += "</nav></div></div></nav>";
    container.innerHTML = html;
  }

  function changePage(page) {
    currentPage = page;
    loadClubs(currentPage, currentSearch, currentCategory);
  }

  async function joinClub(clubId) {
    if (confirm("Are you sure you want to join this club?")) {
      try {
        const response = await fetch("/api/users/clubs/" + clubId + "/join/", {
          method: "POST",
          headers: {
            Authorization: "Bearer " + sessionStorage.getItem("token"),
          },
        });

        if (response.ok) {
          alert("Successfully joined the club!");
          loadClubs(currentPage, currentSearch, currentCategory); // Reload to update member count
        } else {
          const errorData = await response.json();
          alert("Error: " + errorData.error);
        }
      } catch (error) {
        console.error("Error joining club:", error);
        alert("An error occurred while joining the club.");
      }
    }
  }

  // Event listeners
  document.getElementById("searchBtn").addEventListener("click", () => {
    currentSearch = document.getElementById("searchInput").value.trim();
    currentCategory = document.getElementById("categoryFilter").value;
    currentPage = 1;
    loadClubs(currentPage, currentSearch, currentCategory);
  });

  document.getElementById("searchInput").addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      document.getElementById("searchBtn").click();
    }
  });

  async function viewClubDetails(clubId) {
    try {
      const response = await fetch("/api/clubs/public/" + clubId, {
        headers: {
          Accept: "application/json",
        },
      });

      if (!response.ok) throw new Error("Failed to fetch club details");

      const data = await response.json();
      const club = data.club;

      // Populate modal
      document.getElementById("modalTitle").textContent = club.name;

      let content = `
        <div class="space-y-4">
          <div class="flex items-start space-x-4">
            <div class="w-20 h-20 bg-gray-200 rounded-lg flex-shrink-0">
              ${
                club.logo
                  ? `<img src="${club.logo}" alt="${club.name}" class="w-full h-full object-cover rounded-lg">`
                  : '<div class="w-full h-full bg-gray-300 rounded-lg"></div>'
              }
            </div>
            <div class="flex-1">
              <p class="text-gray-700 mb-2">${club.description}</p>
              <div class="flex items-center space-x-4">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${
                  club.category
                }</span>
                <span class="text-sm text-gray-500">${
                  club.memberCount
                } members</span>
              </div>
            </div>
          </div>
          <div class="border-t pt-4">
            <h4 class="font-medium text-gray-900 mb-2">Club Owner</h4>
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 bg-gray-200 rounded-full flex-shrink-0">
                ${
                  club.owner.profilePicture
                    ? `<img src="${club.owner.profilePicture}" alt="${club.owner.firstName} ${club.owner.lastName}" class="w-full h-full object-cover rounded-full">`
                    : '<div class="w-full h-full bg-gray-300 rounded-full"></div>'
                }
              </div>
              <div>
                <p class="text-sm font-medium text-gray-900">${
                  club.owner.firstName
                } ${club.owner.lastName}</p>
                <p class="text-sm text-gray-500">${club.owner.email}</p>
              </div>
            </div>
          </div>
          <div class="border-t pt-4">
            <h4 class="font-medium text-gray-900 mb-2">Members (${
              club.members.length
            })</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-40 overflow-y-auto">
      `;

      if (club.members && club.members.length > 0) {
        club.members.forEach((member) => {
          content += `
            <div class="flex items-center space-x-3">
              <div class="w-8 h-8 bg-gray-200 rounded-full flex-shrink-0">
                ${
                  member.user.profilePicture
                    ? `<img src="${member.user.profilePicture}" alt="${member.user.firstName} ${member.user.lastName}" class="w-full h-full object-cover rounded-full">`
                    : '<div class="w-full h-full bg-gray-300 rounded-full"></div>'
                }
              </div>
              <div>
                <p class="text-xs font-medium text-gray-900">${
                  member.user.firstName
                } ${member.user.lastName}</p>
              </div>
            </div>
          `;
        });
      } else {
        content +=
          '<p class="text-sm text-gray-500 col-span-full">No members yet.</p>';
      }

      content += `
            </div>
          </div>
        </div>
      `;
      document.getElementById("modalContent").innerHTML = content;

      // Show modal
      document.getElementById("clubModal").classList.remove("hidden");
    } catch (error) {
      console.error("Error loading club details:", error);
      alert("An error occurred while loading club details.");
    }
  }

  function closeModal() {
    document.getElementById("clubModal").classList.add("hidden");
  }

  // Close modal when clicking outside
  document.getElementById("clubModal").addEventListener("click", (e) => {
    if (e.target === document.getElementById("clubModal")) {
      closeModal();
    }
  });

  // Load clubs when page loads
  document.addEventListener("DOMContentLoaded", () => {
    const clubId = '<%= typeof club !== "undefined" && club ? club._id : "" %>';
    if (clubId) {
      viewClubDetails(clubId);
    } else {
      loadClubs();
    }
  });

  // Debug: Log when page loads
  console.log("Clubs page loaded");
</script>
` %> <%- include('../layout', { title: title, userRole: userRole, body: body })
%>
