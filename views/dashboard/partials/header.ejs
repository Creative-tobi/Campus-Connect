<% const userData = typeof user !== 'undefined' ? user : (typeof window !==
'undefined' ? getUserData() : null); %> <% const userRole = userData ?
userData.role : 'user'; %> <% const userName = userData ? userData.firstName + '
' + userData.lastName : 'User'; %> <% const userPicture = userData &&
userData.profilePicture ? userData.profilePicture : null; %>

<header class="bg-white shadow-sm">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
      <!-- Mobile menu button -->
      <button
        id="sidebar-toggle"
        class="md:hidden text-gray-500 hover:text-gray-700 focus:outline-none">
        <i class="fas fa-bars text-xl"></i>
      </button>

      <!-- Logo -->
      <div class="flex items-center">
        <div class="bg-blue-600 text-white p-1 rounded-md mr-2">
          <i class="fas fa-university"></i>
        </div>
        <span class="text-lg font-bold text-gray-900 hidden md:block"
          >CampusConnect</span
        >
      </div>

      <!-- Right side icons -->
      <div class="flex items-center space-x-4">
        <button
          id="notification-btn"
          class="text-gray-500 hover:text-gray-700 relative">
          <i class="fas fa-bell"></i>
          <!-- Example notification badge (will be updated by JS) -->
          <span
            id="notification-badge"
            class="hidden absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center"
            >0</span
          >
        </button>
        <div class="relative">
          <button
            id="user-menu-button"
            class="flex items-center text-sm rounded-full focus:outline-none">
            <% if (userPicture) { %>
            <img
              src="<%= userPicture %>"
              alt="Profile Picture"
              class="w-8 h-8 rounded-full object-cover" />
            <% } else { %>
            <!-- Fallback if no picture -->
            <div
              class="bg-gray-200 border-2 border-dashed rounded-full w-8 h-8 flex items-center justify-center">
              <span class="text-gray-500 text-sm"
                ><%= userData ? userData.firstName.charAt(0) : 'U' %></span
              >
            </div>
            <% } %>
          </button>
          <!-- User menu dropdown (hidden by default) -->
          <div
            id="user-menu"
            class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
            <a
              href="/api/users/profile"
              class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
              >Your Profile</a
            >
            <button
              onclick="logout()"
              class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
              Sign out
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<script>
  // User menu toggle
  const userMenuButton = document.getElementById("user-menu-button");
  const userMenu = document.getElementById("user-menu");
  const notificationBtn = document.getElementById("notification-btn");
  const notificationBadge = document.getElementById("notification-badge");

  userMenuButton.addEventListener("click", () => {
    userMenu.classList.toggle("hidden");
  });

  // Close menus if clicked outside
  window.addEventListener("click", (event) => {
    if (
      !userMenu.contains(event.target) &&
      !userMenuButton.contains(event.target)
    ) {
      userMenu.classList.add("hidden");
    }
  });

  // Example: Fetch notification count on load and periodically
  async function fetchNotificationCount() {
    try {
      const response = await fetch("/api/notifications?read=false&limit=1", {
        // Fetch only unread count efficiently
        headers: {
          Authorization: "Bearer " + localStorage.getItem("token"),
        },
      });
      if (response.ok) {
        const data = await response.json();
        const unreadCount = data.notifications ? data.notifications.length : 0; // Or get count from pagination if available
        if (unreadCount > 0) {
          notificationBadge.textContent = unreadCount;
          notificationBadge.classList.remove("hidden");
        } else {
          notificationBadge.classList.add("hidden");
        }
      }
    } catch (error) {
      console.error("Error fetching notification count:", error);
      // Optionally hide badge on error
      notificationBadge.classList.add("hidden");
    }
  }

  // Navigate to notifications page when bell is clicked
  notificationBtn.addEventListener("click", () => {
    window.location.href = "/api/users/notifications"; // Or open a modal
  });

  // Logout function
  function logout() {
    localStorage.removeItem("token");
    localStorage.removeItem("user");
    window.location.href = "/api/auth/login";
  }

  // Load initial count
  document.addEventListener("DOMContentLoaded", fetchNotificationCount);
  // Optionally, refresh count every 30 seconds or so
  // setInterval(fetchNotificationCount, 30000);
</script>
