<!-- This file uses the layout.ejs -->
<% title = 'Club Owner Dashboard | CampusConnect' %> <% userRole = 'club_owner'
<% const body = `
<div class="max-w-4xl mx-auto">
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <h1 class="text-xl font-bold text-gray-900">
      Hello, ${typeof user !== 'undefined' ? user.firstName : 'Club Owner'}!
    </h1>
    <p class="text-gray-600">Manage your club and engage with members.</p>
  </div>

  <!-- Quick Actions -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <a
      href="/api/clubs/my"
      class="bg-white rounded-lg shadow p-4 text-center hover:bg-gray-50">
      <i class="fas fa-chalkboard-teacher text-blue-500 text-2xl mb-2"></i>
      <h3 class="font-medium text-gray-900">My Clubs</h3>
    </a>
    <a
      href="#"
      onclick="navigateToPendingRequests()"
      class="bg-white rounded-lg shadow p-4 text-center hover:bg-gray-50 relative">
      <!-- Link to manage requests -->
      <i class="fas fa-user-check text-green-500 text-2xl mb-2"></i>
      <h3 class="font-medium text-gray-900">Join Requests</h3>
      <span
        id="pendingRequestsBadge"
        class="hidden absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center mt-1"
        >0</span
      >
    </a>
    <a
      href="#"
      onclick="navigateToMyClubs()"
      class="bg-white rounded-lg shadow p-4 text-center hover:bg-gray-50">
      <!-- Link to manage members -->
      <i class="fas fa-users text-purple-500 text-2xl mb-2"></i>
      <h3 class="font-medium text-gray-900">Manage Members</h3>
    </a>
  </div>

  <!-- Create New Club -->
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Create New Club</h2>
    <a
      href="/api/clubs/create"
      class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
      <i class="fas fa-plus mr-2"></i> Create Club
    </a>
  </div>

  <!-- Example Club Activity -->
  <div class="bg-white rounded-lg shadow p-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Recent Activity</h2>
    <div id="recentActivityList">
      <p class="text-gray-500">Loading activity...</p>
    </div>
  </div>
</div>

<script>
  // Example: Fetch recent notifications (activity) for the user
  async function loadRecentActivity() {
    try {
      const response = await fetch("/api/notifications", {
        headers: {
          Authorization: "Bearer " + sessionStorage.getItem("token"),
        },
      });
      if (!response.ok) throw new Error("Failed to fetch notifications");
      const data = await response.json();
      const container = document.getElementById("recentActivityList");
      container.innerHTML = ""; // Clear loading message

      if (data.notifications && data.notifications.length > 0) {
        // Filter for relevant club owner notifications (e.g., JOIN_REQUEST, CLUB_APPROVED)
        const relevantNotifications = data.notifications.filter((n) =>
          [
            "JOIN_REQUEST",
            "CLUB_APPROVED",
            "CLUB_REJECTED",
            "NEW_POST",
          ].includes(n.type)
        );
        let countPendingRequests = 0;

        relevantNotifications.forEach((notification) => {
          const activityDiv = document.createElement("div");
          activityDiv.className =
            "border-b border-gray-200 pb-3 mb-3 last:border-0 last:mb-0"; // Add border between items
          activityDiv.innerHTML = `
                        <div class="flex items-start">
                            <div class="bg-gray-200 border-2 border-dashed rounded-xl w-8 h-8 mr-3"></div> <!-- Icon placeholder -->
                            <div class="flex-1">
                                <p class="text-sm text-gray-800">${
                                  notification.message
                                }</p>
                                <p class="text-xs text-gray-500">${new Date(
                                  notification.createdAt
                                ).toLocaleString()}</p>
                                ${
                                  !notification.read
                                    ? '<span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mt-1">New</span>'
                                    : ""
                                }
                            </div>
                        </div>
                    `;
          container.appendChild(activityDiv);

          // Count pending requests for badge
          if (notification.type === "JOIN_REQUEST" && !notification.read) {
            countPendingRequests++;
          }
        });

        // Update the badge count
        const badge = document.getElementById("pendingRequestsBadge");
        if (countPendingRequests > 0) {
          badge.textContent = countPendingRequests;
          badge.classList.remove("hidden");
        } else {
          badge.classList.add("hidden");
        }
      } else {
        container.innerHTML =
          '<p class="text-gray-500">No recent activity.</p>';
        document.getElementById("pendingRequestsBadge").classList.add("hidden"); // Hide badge if no requests
      }
    } catch (error) {
      console.error("Error loading activity:", error);
      document.getElementById("recentActivityList").innerHTML =
        '<p class="text-red-500">Error loading activity.</p>';
    }
  }

  // Navigate to manage requests for the first club found (simplified)
  async function navigateToPendingRequests() {
    try {
      const response = await fetch("/api/clubs/my", {
        headers: {
          Authorization: "Bearer " + sessionStorage.getItem("token"),
        },
      });
      if (!response.ok) throw new Error("Failed to fetch clubs");
      const data = await response.json();

      if (data.clubs && data.clubs.length > 0) {
        // Redirect to manage page of the first club
        window.location.href = `/api/clubs/${data.clubs[0]._id}/manage`;
      } else {
        alert("You do not own any clubs yet.");
      }
    } catch (error) {
      console.error("Error fetching clubs for requests:", error);
      alert("An error occurred while navigating to requests.");
    }
  }

  // Navigate to manage members for the first club found (simplified)
  async function navigateToMyClubs() {
    // This just navigates to the 'My Clubs' list page
    window.location.href = "/api/clubs/my";
  }

  // Load activity when page loads
  document.addEventListener("DOMContentLoaded", loadRecentActivity);
</script>
` %> <%- include('../layout', { title: title, userRole: userRole, body: body })%>
