<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
        .token-link { cursor: pointer; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col min-h-screen">

<nav class="bg-white shadow-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
            
            <div class="flex items-center">
                <a href="/" class="flex-shrink-0 flex items-center">
                    <i class="fas fa-graduation-cap text-blue-600 text-3xl mr-2"></i>
                    <span class="font-bold text-xl tracking-tight text-gray-900">Campus Connect</span>
                </a>
                
                <div class="hidden md:ml-6 md:flex md:space-x-8">
                    <a href="/" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Home</a>
                    <a href="/clubs" id="desk-explore" class="token-link border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Explore Clubs</a>
                    <a href="#" id="desk-dashboard" class="hidden token-link border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 items-center px-1 pt-1 border-b-2 text-sm font-medium">Dashboard</a>
                </div>
            </div>

            <div class="hidden md:flex items-center">
                <div id="desk-auth-buttons" class="flex space-x-4">
                    <a href="/api/auth/login" class="text-gray-500 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">Log in</a>
                    <a href="/api/auth/register" class="bg-blue-600 text-white hover:bg-blue-700 px-4 py-2 rounded-md text-sm font-medium shadow-sm transition">Sign up</a>
                </div>

                <div id="desk-user-menu" class="hidden ml-3 relative flex items-center space-x-4">
                    <a href="/api/users/notifications" class="token-link text-gray-400 hover:text-gray-500 relative">
                        <span class="sr-only">View notifications</span>
                        <i class="fas fa-bell text-xl"></i>
                        <span id="notif-badge" class="absolute top-0 right-0 block h-2 w-2 rounded-full ring-2 ring-white bg-red-400 hidden"></span>
                    </a>

                    <div class="relative ml-3">
                        <button onclick="toggleProfileMenu()" class="bg-white rounded-full flex text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <img id="header-avatar" class="h-8 w-8 rounded-full object-cover border border-gray-200" src="https://via.placeholder.com/32" alt="">
                        </button>
                        
                        <div id="profile-dropdown" class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 z-50">
                            <div class="px-4 py-2 border-b">
                                <p class="text-xs text-gray-500">Signed in as</p>
                                <p id="header-username" class="text-sm font-bold text-gray-900 truncate">User</p>
                            </div>
                            <a href="/api/users/profile" class="token-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Your Profile</a>
                            <a href="/api/clubs/my" id="desk-owner-portal" class="hidden token-link block px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 font-bold">Owner Portal</a>
                            <a href="#" onclick="logout()" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Sign out</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex items-center md:hidden">
                <button onclick="toggleMobileMenu()" class="text-gray-500 hover:text-gray-700 focus:outline-none p-2">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="mobile-menu" class="hidden md:hidden border-t border-gray-200 bg-white">
        <div class="pt-2 pb-3 space-y-1 px-4">
            <a href="/" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Home</a>
            <a href="/clubs" id="mob-explore" class="token-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Explore Clubs</a>
            
            <a href="#" id="mob-dashboard" class="hidden token-link block px-3 py-2 rounded-md text-base font-medium text-blue-600 bg-blue-50">Dashboard</a>
            <a href="/api/clubs/my" id="mob-owner-portal" class="hidden token-link block px-3 py-2 rounded-md text-base font-medium text-purple-600 bg-purple-50">Owner Portal</a>
        </div>

        <div class="pt-4 pb-4 border-t border-gray-200 px-4">
            <div id="mob-auth-buttons" class="space-y-2">
                <a href="/api/auth/login" class="block w-full text-center px-4 py-2 border border-gray-300 rounded-md text-base font-medium text-gray-700 bg-white hover:bg-gray-50">Log in</a>
                <a href="/api/auth/register" class="block w-full text-center px-4 py-2 border border-transparent rounded-md text-base font-medium text-white bg-blue-600 hover:bg-blue-700">Sign up</a>
            </div>

            <div id="mob-user-menu" class="hidden">
                <div class="flex items-center mb-3">
                    <div class="flex-shrink-0">
                        <img id="mob-avatar" class="h-10 w-10 rounded-full object-cover border border-gray-200" src="https://via.placeholder.com/40" alt="">
                    </div>
                    <div class="ml-3">
                        <div id="mob-username" class="text-base font-medium text-gray-800">User</div>
                        <div class="text-sm font-medium text-gray-500">Signed in</div>
                    </div>
                    <a href="/api/users/notifications" class="token-link ml-auto flex-shrink-0 bg-white p-1 rounded-full text-gray-400 hover:text-gray-500">
                        <span class="sr-only">View notifications</span>
                        <i class="fas fa-bell text-xl"></i>
                    </a>
                </div>
                <div class="space-y-1">
                    <a href="/api/users/profile" class="token-link block px-3 py-2 rounded-md text-base font-medium text-gray-500 hover:text-gray-900 hover:bg-gray-50">Your Profile</a>
                    <a href="#" onclick="logout()" class="block px-3 py-2 rounded-md text-base font-medium text-red-600 hover:text-red-800 hover:bg-red-50">Sign out</a>
                </div>
            </div>
        </div>
    </div>
</nav>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("token");
        const userStr = localStorage.getItem("user");
        const role = localStorage.getItem("role");

        if (token && userStr) {
            const user = JSON.parse(userStr);

            // --- DESKTOP UI UPDATE ---
            document.getElementById("desk-auth-buttons").classList.add("hidden");
            document.getElementById("desk-user-menu").classList.remove("hidden");
            document.getElementById("desk-user-menu").classList.add("flex");
            
            document.getElementById("header-username").textContent = user.firstName;
            document.getElementById("header-avatar").src = user.profilePicture || "https://via.placeholder.com/32";

            // --- MOBILE UI UPDATE ---
            document.getElementById("mob-auth-buttons").classList.add("hidden");
            document.getElementById("mob-user-menu").classList.remove("hidden");
            
            document.getElementById("mob-username").textContent = user.firstName + " " + user.lastName;
            document.getElementById("mob-avatar").src = user.profilePicture || "https://via.placeholder.com/40";

            // --- ROLE BASED LINKS (Both Mobile & Desktop) ---
            
            // 1. Dashboard Link
            let dashUrl = "/api/users/dashboard";
            if (role === "club_owner") dashUrl = "/api/clubs/my";
            if (role === "admin") dashUrl = "/api/admin/dashboard";

            // Show Desktop Dashboard
            const deskDash = document.getElementById("desk-dashboard");
            deskDash.classList.remove("hidden");
            deskDash.classList.add("inline-flex");
            deskDash.href = dashUrl;

            // Show Mobile Dashboard
            const mobDash = document.getElementById("mob-dashboard");
            mobDash.classList.remove("hidden");
            mobDash.href = dashUrl;

            // 2. Owner Portal (Club Owners Only)
            if (role === "club_owner") {
                document.getElementById("desk-owner-portal").classList.remove("hidden");
                document.getElementById("mob-owner-portal").classList.remove("hidden");
            }

            // 3. Admin Hide Explore
            if (role === "admin") {
                document.getElementById("desk-explore").classList.add("hidden");
                document.getElementById("mob-explore").classList.add("hidden");
            }

            // --- APPEND TOKENS ---
            document.querySelectorAll(".token-link").forEach((link) => {
                // Ensure specific ID links are forced to correct href if needed
                if(link.id === 'desk-owner-portal' || link.id === 'mob-owner-portal') link.href = "/api/clubs/my";
                
                const separator = link.href.includes("?") ? "&" : "?";
                link.href = `${link.href}${separator}token=${token}`;
            });
        }
    });

    function toggleProfileMenu() {
        document.getElementById("profile-dropdown").classList.toggle("hidden");
    }

    function toggleMobileMenu() {
        document.getElementById("mobile-menu").classList.toggle("hidden");
    }

    document.addEventListener("click", (e) => {
        const menu = document.getElementById("profile-dropdown");
        const btn = document.querySelector('button[onclick="toggleProfileMenu()"]');
        if (!menu.classList.contains("hidden") && !menu.contains(e.target) && !btn.contains(e.target)) {
            menu.classList.add("hidden");
        }
    });

    function logout() {
        localStorage.clear();
        window.location.href = "/api/auth/login";
    }
</script>

<main class="flex-grow">