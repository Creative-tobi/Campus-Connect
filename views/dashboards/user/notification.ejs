<%- include('../../partials/header') %>

<div
  class="max-w-3xl mx-auto bg-white border rounded-lg shadow-sm min-h-[600px]">
  <div
    class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
    <h1 class="text-xl font-bold text-gray-800">Notifications</h1>
    <button
      onclick="markAllRead()"
      class="text-sm text-blue-600 hover:text-blue-800">
      Mark all as read
    </button>
  </div>

  <div id="notification-list" class="divide-y">
    <div class="p-8 text-center text-gray-500">
      <i class="fas fa-spinner fa-spin"></i> Loading...
    </div>
  </div>
</div>

<script>
  const token = localStorage.getItem("token");

  document.addEventListener("DOMContentLoaded", loadNotifications);

  async function loadNotifications() {
    // Use format=json to ensure backend returns JSON instead of rendering view recursively
    const res = await fetch("/api/users/notifications?format=json", {
      headers: { Authorization: `Bearer ${token}` },
    });
    const data = await res.json();
    const list = document.getElementById("notification-list");
    list.innerHTML = "";

    if (data.notifications && data.notifications.length > 0) {
      data.notifications.forEach((notif) => {
        const isUnread = !notif.read;
        list.innerHTML += `
                    <div class="p-4 hover:bg-gray-50 transition flex justify-between items-start ${
                      isUnread ? "bg-blue-50" : ""
                    }">
                        <div class="flex gap-3">
                            <div class="mt-1">
                                <i class="fas fa-bell ${
                                  isUnread ? "text-blue-600" : "text-gray-400"
                                }"></i>
                            </div>
                            <div>
                                <p class="text-gray-800 text-sm">${
                                  notif.message
                                }</p>
                                <span class="text-xs text-gray-500">${new Date(
                                  notif.createdAt
                                ).toLocaleDateString()}</span>
                            </div>
                        </div>
                        ${
                          isUnread
                            ? `<button onclick="markRead('${notif._id}')" class="text-xs bg-white border px-2 py-1 rounded text-gray-600 hover:bg-gray-100">Mark Read</button>`
                            : ""
                        }
                    </div>
                `;
      });
    } else {
      list.innerHTML = `<div class="p-10 text-center text-gray-400">No notifications.</div>`;
    }
  }

  async function markRead(id) {
    await fetch(`/api/users/notifications/${id}/read`, {
      method: "PUT",
      headers: { Authorization: `Bearer ${token}` },
    });
    loadNotifications();
  }

  async function markAllRead() {
    // Get all unread notifications and mark them as read
    const res = await fetch("/api/users/notifications?read=false&format=json", {
      headers: { Authorization: `Bearer ${token}` },
    });
    const data = await res.json();
    if (data.notifications) {
      await Promise.all(
        data.notifications.map((notif) =>
          fetch(`/api/users/notifications/${notif._id}/read`, {
            method: "PUT",
            headers: { Authorization: `Bearer ${token}` },
          })
        )
      );
    }
    loadNotifications();
  }
</script>

<%- include('../../partials/footer') %>
