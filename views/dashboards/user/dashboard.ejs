<%- include('../../partials/header') %>

<div class="grid grid-cols-1 md:grid-cols-4 gap-6">
  <div class="md:col-span-1">
    <div class="bg-white p-6 rounded-lg shadow-sm border text-center">
      <% if (user.profilePicture) { %>
      <img
        src="<%= user.profilePicture %>"
        class="w-24 h-24 rounded-full mx-auto mb-4 object-cover" />
      <% } else { %>
      <div
        class="w-24 h-24 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold text-2xl mx-auto mb-4">
        <%= user.firstName.charAt(0).toUpperCase() %>
      </div>
      <% } %>
      <h3 class="font-bold text-lg">
        <%= user.firstName %> <%= user.lastName %>
      </h3>
      <p class="text-gray-500 text-sm capitalize">
        <%= user.role.replace('_', ' ') %>
      </p>
      <p class="text-gray-400 text-xs mt-1"><%= user.faculty %></p>

      <% if(user.role === 'club_owner') { %>
      <hr class="my-4" />
      <a
        href="/api/clubs/create"
        class="token-link block w-full bg-blue-600 text-white text-sm py-2 rounded mb-2"
        >Create New Club</a
      >
      <a
        href="/api/clubs/my"
        class="token-link block w-full bg-gray-100 text-gray-700 text-sm py-2 rounded hover:bg-gray-200"
        >Manage My Clubs</a
      >
      <% } else { %>
      <hr class="my-4" />
      <a
        href="/api/clubs/create"
        class="token-link block w-full bg-green-600 text-white text-sm py-2 rounded mb-2 hover:bg-green-700"
        >Create a Club</a
      >
      <% } %>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-sm border mt-6">
      <h4 class="font-bold text-gray-700 mb-3">Your Clubs</h4>
      <% if (locals.joinedClubs && joinedClubs.length > 0) { %>
      <ul class="space-y-2">
        <% joinedClubs.forEach(club => { %>
        <li class="flex items-center justify-between">
          <a
            href="/api/clubs/<%= club._id %>"
            class="token-link flex items-center text-sm text-gray-600 hover:text-blue-600 flex-1">
            <% if (club.logo) { %>
            <img src="<%= club.logo %>" class="w-6 h-6 rounded mr-2" />
            <% } else { %>
            <div
              class="w-6 h-6 rounded bg-blue-500 flex items-center justify-center text-white font-bold text-xs mr-2">
              <%= club.name.charAt(0).toUpperCase() %>
            </div>
            <% } %> <%= club.name %>
          </a>
          <button
            onclick="leaveClub('<%= club._id %>', '<%= club.name %>')"
            class="text-red-500 hover:text-red-700 text-sm ml-2">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </li>
        <% }) %>
      </ul>
      <% } else { %>
      <p class="text-sm text-gray-400">You haven't joined any clubs yet.</p>
      <a href="/api/clubs" class="token-link text-xs text-blue-500 mt-2 block"
        >Browse Clubs</a
      >
      <% } %>
    </div>
  </div>

  <div class="md:col-span-3">
    <div class="bg-white p-6 rounded-lg shadow-sm border mb-6">
      <h2 class="text-xl font-bold mb-2">Welcome, <%= user.firstName %>!</h2>
      <p class="text-gray-600">Connect with your campus community.</p>
    </div>

    <div id="posts-container" class="space-y-6">
      <div class="text-center py-8">
        <i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>
        <p class="text-gray-500 mt-2">Loading your feed...</p>
      </div>
    </div>
  </div>
</div>

<script>
  // Fetch posts compatible with the backend structure
  document.addEventListener("DOMContentLoaded", async () => {
    const token = localStorage.getItem("token");
    if (!token) return;

    try {
      const res = await fetch("/api/users/posts", {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();

      const container = document.getElementById("posts-container");
      container.innerHTML = "";

      if (data.posts && data.posts.length > 0) {
        data.posts.forEach((post) => {
          container.innerHTML += `
                        <div class="bg-white p-6 rounded-lg shadow-sm border">
                            <div class="flex items-center mb-4">
                                ${
                                  post.author.profilePicture
                                    ? `<img src="${post.author.profilePicture}" class="w-10 h-10 rounded-full mr-3">`
                                    : `<div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold mr-3">${post.author.firstName
                                        .charAt(0)
                                        .toUpperCase()}</div>`
                                }
                                <div>
                                    <h4 class="font-bold text-sm">${
                                      post.author.firstName
                                    } ${post.author.lastName}</h4>
                                    <p class="text-xs text-gray-500">Posted in ${
                                      post.club ? post.club.name : "General"
                                    }</p>
                                </div>
                            </div>
                            <h3 class="font-bold text-lg mb-2">${
                              post.title
                            }</h3>
                            <p class="text-gray-700 mb-4 whitespace-pre-line">${
                              post.content
                            }</p>
                            ${
                              post.media
                                ? `<img src="${post.media}" class="w-full rounded-lg mb-4 max-h-96 object-cover">`
                                : ""
                            }
                        </div>
                    `;
        });
      } else {
        container.innerHTML = `<div class="text-center text-gray-500 py-10">No posts yet. Join some clubs to see content!</div>`;
      }
    } catch (error) {
      console.error(error);
    }
  });

  async function leaveClub(clubId, clubName) {
    if (confirm(`Are you sure you want to leave ${clubName}?`)) {
      const token = localStorage.getItem("token");
      try {
        const res = await fetch(`/api/users/clubs/${clubId}/leave`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${token}` },
        });
        if (res.ok) {
          alert(`You have left ${clubName} successfully`);
          location.reload(); // Refresh the page to update the clubs list
        } else {
          alert("Error leaving the club");
        }
      } catch (err) {
        console.error(err);
      }
    }
  }
</script>

<%- include('../../partials/footer') %>
