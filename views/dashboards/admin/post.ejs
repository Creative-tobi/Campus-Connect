<%- include('../../partials/header') %>

<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Manage Posts</h1>
        <div class="flex gap-2">
            <input type="text" id="searchPost" placeholder="Search content..." class="border p-2 rounded w-64">
            <button onclick="loadPosts()" class="bg-blue-600 text-white px-4 py-2 rounded">Search</button>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow overflow-hidden border">
        <table class="min-w-full leading-normal">
            <thead>
                <tr>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">Post Details</th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">Author / Club</th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">Date</th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody id="posts-table-body">
                </tbody>
        </table>
        <div class="px-5 py-5 bg-white border-t flex items-center justify-between" id="pagination-controls"></div>
    </div>
</div>

<script>
    const token = localStorage.getItem('token');
    
    document.addEventListener("DOMContentLoaded", () => loadPosts());

    async function loadPosts(page = 1) {
        const search = document.getElementById('searchPost').value;
        let query = `?page=${page}&limit=10`;
        if (search) query += `&search=${search}`;

        try {
            // Fetches all posts using the admin controller endpoint
            const res = await fetch(`/api/admin/posts/data${query}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            
            const tbody = document.getElementById('posts-table-body');
            tbody.innerHTML = '';

            if (data.posts && data.posts.length > 0) {
                data.posts.forEach(post => {
                    tbody.innerHTML += `
                        <tr>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm w-1/2">
                                <p class="text-gray-900 font-bold mb-1">${post.title}</p>
                                <p class="text-gray-500 text-xs line-clamp-2">${post.content}</p>
                                ${post.media ? `<a href="${post.media}" target="_blank" class="text-blue-500 text-xs mt-1 inline-block hover:underline"><i class="fas fa-image"></i> View Image</a>` : ''}
                            </td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                <p class="text-gray-900 font-semibold">${post.author ? post.author.firstName + ' ' + post.author.lastName : 'Unknown'}</p>
                                <p class="text-blue-600 text-xs mt-1">
                                    <i class="fas fa-users"></i> ${post.club ? post.club.name : 'Unknown Club'}
                                </p>
                            </td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                <span class="text-gray-500 whitespace-no-wrap">${new Date(post.createdAt).toLocaleDateString()}</span>
                            </td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-right">
                                <button onclick="deletePost('${post._id}')" class="bg-red-50 text-red-600 hover:bg-red-100 p-2 rounded transition" title="Delete Post">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                renderPagination(data.pagination);
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-10 text-gray-500">No posts found</td></tr>';
            }
        } catch (error) { console.error(error); }
    }

    async function deletePost(id) {
        if(!confirm('Permanently delete this post?')) return;
        const res = await fetch(`/api/admin/posts/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if(res.ok) loadPosts();
        else alert('Failed to delete post');
    }

    function renderPagination(pagination) {
        const div = document.getElementById('pagination-controls');
        div.innerHTML = `
            <span class="text-xs text-gray-900">Page ${pagination.current} of ${pagination.pages}</span>
            <div class="inline-flex mt-2 xs:mt-0">
                <button ${pagination.current === 1 ? 'disabled' : ''} onclick="loadPosts(${pagination.current - 1})" class="text-sm bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-l disabled:opacity-50">Prev</button>
                <button ${pagination.current === pagination.pages ? 'disabled' : ''} onclick="loadPosts(${pagination.current + 1})" class="text-sm bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-r disabled:opacity-50">Next</button>
            </div>
        `;
    }
</script>

<%- include('../../partials/footer') %>