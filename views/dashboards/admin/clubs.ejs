<%- include('../../partials/header') %>

<div class="container mx-auto px-4 py-8">
  
  <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
    <h1 class="text-2xl font-bold text-gray-800 w-full md:w-auto text-center md:text-left">
      Manage Clubs
    </h1>
    
    <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
      <select
        id="statusFilter"
        onchange="loadClubs()"
        class="border border-gray-300 p-2 rounded-lg w-full sm:w-auto focus:ring-2 focus:ring-blue-500 outline-none">
        <option value="">All Statuses</option>
        <option value="pending">Pending Approval</option>
        <option value="active">Active</option>
      </select>
      
      <input
        type="text"
        id="searchClub"
        placeholder="Search clubs..."
        class="border border-gray-300 p-2 rounded-lg w-full sm:w-64 focus:ring-2 focus:ring-blue-500 outline-none" />
      
      <button
        onclick="loadClubs()"
        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg w-full sm:w-auto transition shadow-sm font-medium">
        Search
      </button>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full leading-normal">
        <thead>
          <tr>
            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider whitespace-nowrap">
              Club Name
            </th>
            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider whitespace-nowrap">
              Owner
            </th>
            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider whitespace-nowrap">
              Category
            </th>
            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider whitespace-nowrap">
              Status
            </th>
            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-50 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider whitespace-nowrap">
              Actions
            </th>
          </tr>
        </thead>
        <tbody id="clubs-table-body">
            </tbody>
      </table>
    </div>

    <div
      class="px-5 py-5 bg-white border-t flex flex-col xs:flex-row items-center xs:justify-between"
      id="pagination-controls">
    </div>
  </div>
</div>

<script>
  const token = localStorage.getItem("token");
  let currentPage = 1;

  document.addEventListener("DOMContentLoaded", () => {
    // Check URL params for status filter
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get("status")) {
      document.getElementById("statusFilter").value = urlParams.get("status");
    }
    loadClubs();
  });

  async function loadClubs(page = 1) {
    currentPage = page;
    const status = document.getElementById("statusFilter").value;
    const search = document.getElementById("searchClub").value;

    let query = `?page=${page}&limit=10`;
    if (status) query += `&status=${status}`;
    if (search) query += `&search=${search}`;

    try {
      const res = await fetch(`/api/admin/clubs/data${query}`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();

      const tbody = document.getElementById("clubs-table-body");
      tbody.innerHTML = "";

      if (data.clubs && data.clubs.length > 0) {
        data.clubs.forEach((club) => {
          // Logic for action buttons based on status
          let actionButtons = "";

          if (club.status === "pending") {
            actionButtons += `
                <button onclick="approveClub('${club._id}')" class="bg-green-100 text-green-600 hover:bg-green-200 p-2 rounded mr-2 transition" title="Approve">
                    <i class="fas fa-check"></i>
                </button>
                <button onclick="rejectClub('${club._id}')" class="bg-red-100 text-red-600 hover:bg-red-200 p-2 rounded mr-2 transition" title="Reject">
                    <i class="fas fa-times"></i>
                </button>
            `;
          }

          // Delete button always visible
          actionButtons += `
            <button onclick="deleteClub('${club._id}')" class="text-gray-400 hover:text-red-600 p-2 transition" title="Delete Club">
                <i class="fas fa-trash"></i>
            </button>
          `;

          tbody.innerHTML += `
            <tr class="hover:bg-gray-50 transition">
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 w-10 h-10">
                            ${
                              club.logo
                                ? `<img class="w-full h-full rounded-full object-cover border border-gray-200" src="${club.logo}" alt="" onerror="this.src='https://via.placeholder.com/40'"/>`
                                : `<div class="w-full h-full rounded-full bg-blue-500 flex items-center justify-center text-white font-bold text-sm border border-gray-200">${club.name.charAt(0).toUpperCase()}</div>`
                            }
                        </div>
                        <div class="ml-3">
                            <p class="text-gray-900 font-bold whitespace-nowrap">${club.name}</p>
                            <p class="text-gray-500 text-xs truncate w-32 sm:w-48">${club.description || ''}</p>
                        </div>
                    </div>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm whitespace-nowrap">
                    <p class="text-gray-900 font-medium">
                        ${club.owner ? club.owner.firstName + " " + club.owner.lastName : "Unknown"}
                    </p>
                    <p class="text-gray-500 text-xs">${club.owner ? club.owner.email : ""}</p>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <span class="px-3 py-1 bg-gray-100 rounded-full text-xs font-semibold text-gray-600 whitespace-nowrap">
                        ${club.category}
                    </span>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <span class="relative inline-block px-3 py-1 font-semibold leading-tight ${
                      club.status === "active" ? "text-green-900" : "text-yellow-900"
                    }">
                        <span aria-hidden class="absolute inset-0 ${
                          club.status === "active" ? "bg-green-200" : "bg-yellow-200"
                        } opacity-50 rounded-full"></span>
                        <span class="relative capitalize text-xs">${club.status}</span>
                    </span>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-right whitespace-nowrap">
                    ${actionButtons}
                </td>
            </tr>
          `;
        });
        
        renderPagination(data.pagination);
      } else {
        tbody.innerHTML =
          '<tr><td colspan="5" class="text-center py-10 text-gray-500">No clubs found</td></tr>';
        document.getElementById("pagination-controls").innerHTML = '';
      }
    } catch (error) {
      console.error(error);
      const tbody = document.getElementById("clubs-table-body");
      tbody.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-red-500">Error loading data</td></tr>';
    }
  }

  function renderPagination(pagination) {
    const div = document.getElementById("pagination-controls");
    div.innerHTML = `
        <span class="text-xs text-gray-900 mb-2 xs:mb-0">
            Page ${pagination.current} of ${pagination.pages}
        </span>
        <div class="inline-flex xs:mt-0">
            <button ${pagination.current === 1 ? "disabled" : ""} 
                onclick="loadClubs(${pagination.current - 1})" 
                class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-l border border-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition">
                Prev
            </button>
            <button ${pagination.current === pagination.pages ? "disabled" : ""} 
                onclick="loadClubs(${pagination.current + 1})" 
                class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-r border border-gray-300 border-l-0 disabled:opacity-50 disabled:cursor-not-allowed transition">
                Next
            </button>
        </div>
    `;
  }

  // --- Actions ---
  async function approveClub(id) {
    if (!confirm("Approve this club?")) return;
    try {
        const res = await fetch(`/api/admin/clubs/${id}/approve`, {
          method: "PUT",
          headers: { Authorization: `Bearer ${token}` },
        });
        if (res.ok) loadClubs(currentPage);
        else alert("Failed to approve");
    } catch(e) { console.error(e); }
  }

  async function rejectClub(id) {
    if (!confirm("Reject (and delete) this club?")) return;
    try {
        const res = await fetch(`/api/admin/clubs/${id}/reject`, {
          method: "PUT",
          headers: { Authorization: `Bearer ${token}` },
        });
        if (res.ok) loadClubs(currentPage);
        else alert("Failed to reject");
    } catch(e) { console.error(e); }
  }

  async function deleteClub(id) {
    if (!confirm("Permanently delete this club?")) return;
    try {
        const res = await fetch(`/api/admin/clubs/${id}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${token}` },
        });
        if (res.ok) loadClubs(currentPage);
        else alert("Failed to delete");
    } catch(e) { console.error(e); }
  }
</script>