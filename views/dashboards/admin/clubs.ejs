<%- include('../../partials/header') %>

<div class="container mx-auto px-4 py-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">Manage Clubs</h1>
    <div class="flex gap-2">
      <select
        id="statusFilter"
        onchange="loadClubs()"
        class="border p-2 rounded">
        <option value="">All Statuses</option>
        <option value="pending">Pending Approval</option>
        <option value="active">Active</option>
      </select>
      <input
        type="text"
        id="searchClub"
        placeholder="Search clubs..."
        class="border p-2 rounded w-64" />
      <button
        onclick="loadClubs()"
        class="bg-blue-600 text-white px-4 py-2 rounded">
        Search
      </button>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow overflow-hidden border">
    <table class="min-w-full leading-normal">
      <thead>
        <tr>
          <th
            class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">
            Club Name
          </th>
          <th
            class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">
            Owner
          </th>
          <th
            class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">
            Category
          </th>
          <th
            class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">
            Status
          </th>
          <th
            class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase">
            Actions
          </th>
        </tr>
      </thead>
      <tbody id="clubs-table-body"></tbody>
    </table>

    <div
      class="px-5 py-5 bg-white border-t flex items-center justify-between"
      id="pagination-controls"></div>
  </div>
</div>

<script>
  const token = localStorage.getItem("token");
  let currentPage = 1;

  document.addEventListener("DOMContentLoaded", () => {
    // Check URL params for status filter (e.g. from dashboard link)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get("status")) {
      document.getElementById("statusFilter").value = urlParams.get("status");
    }
    loadClubs();
  });

  async function loadClubs(page = 1) {
    currentPage = page;
    const status = document.getElementById("statusFilter").value;
    const search = document.getElementById("searchClub").value;

    let query = `?page=${page}&limit=10`;
    if (status) query += `&status=${status}`;
    if (search) query += `&search=${search}`;

    try {
      const res = await fetch(`/api/admin/clubs/data${query}`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();

      const tbody = document.getElementById("clubs-table-body");
      tbody.innerHTML = "";

      if (data.clubs && data.clubs.length > 0) {
        data.clubs.forEach((club) => {
          // Logic for action buttons based on status
          let actionButtons = "";

          if (club.status === "pending") {
            actionButtons += `
                            <button onclick="approveClub('${club._id}')" class="bg-green-100 text-green-600 hover:bg-green-200 p-2 rounded mr-1" title="Approve">
                                <i class="fas fa-check"></i>
                            </button>
                            <button onclick="rejectClub('${club._id}')" class="bg-red-100 text-red-600 hover:bg-red-200 p-2 rounded mr-1" title="Reject">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
          }

          // Delete button always visible
          actionButtons += `
                        <button onclick="deleteClub('${club._id}')" class="text-gray-400 hover:text-red-600 p-2" title="Delete Club">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;

          tbody.innerHTML += `
                        <tr>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 w-10 h-10">
                                        ${
                                          club.logo
                                            ? `<img class="w-full h-full rounded-full object-cover" src="${club.logo}" alt="" />`
                                            : `<div class="w-full h-full rounded-full bg-blue-500 flex items-center justify-center text-white font-bold">${club.name
                                                .charAt(0)
                                                .toUpperCase()}</div>`
                                        }
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-gray-900 whitespace-no-wrap font-bold">${
                                          club.name
                                        }</p>
                                        <p class="text-gray-500 text-xs truncate w-40">${
                                          club.description
                                        }</p>
                                    </div>
                                </div>
                            </td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                <p class="text-gray-900 whitespace-no-wrap">${
                                  club.owner
                                    ? club.owner.firstName +
                                      " " +
                                      club.owner.lastName
                                    : "Unknown"
                                }</p>
                                <p class="text-gray-500 text-xs">${
                                  club.owner ? club.owner.email : ""
                                }</p>
                            </td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                <span class="px-3 py-1 bg-gray-100 rounded-full text-xs">${
                                  club.category
                                }</span>
                            </td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                <span class="relative inline-block px-3 py-1 font-semibold leading-tight ${
                                  club.status === "active"
                                    ? "text-green-900"
                                    : "text-yellow-900"
                                }">
                                    <span aria-hidden class="absolute inset-0 ${
                                      club.status === "active"
                                        ? "bg-green-200"
                                        : "bg-yellow-200"
                                    } opacity-50 rounded-full"></span>
                                    <span class="relative capitalize">${
                                      club.status
                                    }</span>
                                </span>
                            </td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-right">
                                ${actionButtons}
                            </td>
                        </tr>
                    `;
        });
        renderPagination(data.pagination);
      } else {
        tbody.innerHTML =
          '<tr><td colspan="5" class="text-center py-10 text-gray-500">No clubs found</td></tr>';
      }
    } catch (error) {
      console.error(error);
    }
  }

  // Action Functions
  async function approveClub(id) {
    if (!confirm("Approve this club?")) return;
    const res = await fetch(`/api/admin/clubs/${id}/approve`, {
      method: "PUT",
      headers: { Authorization: `Bearer ${token}` },
    });
    if (res.ok) loadClubs(currentPage);
  }

  async function rejectClub(id) {
    if (!confirm("Reject (and delete) this club?")) return;
    const res = await fetch(`/api/admin/clubs/${id}/reject`, {
      method: "PUT",
      headers: { Authorization: `Bearer ${token}` },
    });
    if (res.ok) loadClubs(currentPage);
  }

  async function deleteClub(id) {
    if (!confirm("Permanently delete this club?")) return;
    const res = await fetch(`/api/admin/clubs/${id}`, {
      method: "DELETE",
      headers: { Authorization: `Bearer ${token}` },
    });
    if (res.ok) loadClubs(currentPage);
  }

  function renderPagination(pagination) {
    const div = document.getElementById("pagination-controls");
    div.innerHTML = `
            <span class="text-xs text-gray-900">
                Page ${pagination.current} of ${pagination.pages}
            </span>
            <div class="inline-flex mt-2 xs:mt-0">
                <button ${
                  pagination.current === 1 ? "disabled" : ""
                } onclick="loadClubs(${
      pagination.current - 1
    })" class="text-sm bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-l disabled:opacity-50">Prev</button>
                <button ${
                  pagination.current === pagination.pages ? "disabled" : ""
                } onclick="loadClubs(${
      pagination.current + 1
    })" class="text-sm bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-r disabled:opacity-50">Next</button>
            </div>
        `;
  }
</script>

<%- include('../../partials/footer') %>
