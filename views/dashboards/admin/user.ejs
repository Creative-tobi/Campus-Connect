<%- include('../../partials/header') %>

<div class="container mx-auto px-4 py-8">
  
  <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
    <h1 class="text-2xl font-bold text-gray-800 w-full md:w-auto text-center md:text-left">
      Manage Users
    </h1>
    
    <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
      <select 
        id="roleFilter" 
        onchange="loadUsers()" 
        class="border border-gray-300 p-2 rounded-lg w-full sm:w-auto focus:ring-2 focus:ring-blue-500 outline-none">
        <option value="">All Roles</option>
        <option value="user">User</option>
        <option value="club_owner">Club Owner</option>
        <option value="admin">Admin</option>
      </select>
      
      <input
        type="text"
        id="searchUser"
        placeholder="Search by name or email..."
        class="border border-gray-300 p-2 rounded-lg w-full sm:w-64 focus:ring-2 focus:ring-blue-500 outline-none" />
      
      <button
        onclick="loadUsers()"
        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg w-full sm:w-auto transition shadow-sm font-medium">
        Search
      </button>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full leading-normal">
        <thead>
          <tr>
            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider whitespace-nowrap">
              User
            </th>
            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider whitespace-nowrap">
              Role
            </th>
            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider whitespace-nowrap">
              Status
            </th>
            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider whitespace-nowrap">
              Joined
            </th>
            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider whitespace-nowrap">
              Actions
            </th>
          </tr>
        </thead>
        <tbody id="users-table-body">
            </tbody>
      </table>
    </div>

    <div
      class="px-5 py-5 bg-white border-t flex flex-col xs:flex-row items-center xs:justify-between"
      id="pagination-controls">
    </div>
  </div>
</div>

<script>
  const token = localStorage.getItem("token");
  let currentPage = 1;

  document.addEventListener("DOMContentLoaded", () => loadUsers());

  async function loadUsers(page = 1) {
    currentPage = page;
    const role = document.getElementById("roleFilter").value;
    const search = document.getElementById("searchUser").value;

    let query = `?page=${page}&limit=10`;
    if (role) query += `&role=${role}`;
    if (search) query += `&search=${search}`;

    try {
      const res = await fetch(`/api/admin/users/data${query}`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();

      const tbody = document.getElementById("users-table-body");
      tbody.innerHTML = "";

      if (data.users && data.users.length > 0) {
        data.users.forEach((user) => {
          const isActive = user.isActive;
          const profilePic = user.profilePicture || "https://via.placeholder.com/40";

          tbody.innerHTML += `
            <tr class="hover:bg-gray-50 transition">
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 w-10 h-10">
                            <img class="w-full h-full rounded-full object-cover border border-gray-200" 
                                 src="${profilePic}" 
                                 onerror="this.src='https://via.placeholder.com/40'" 
                                 alt="" />
                        </div>
                        <div class="ml-3">
                            <p class="text-gray-900 font-bold whitespace-nowrap">
                                ${user.firstName} ${user.lastName}
                            </p>
                            <p class="text-gray-500 text-xs truncate w-32 md:w-48">
                                ${user.email}
                            </p>
                        </div>
                    </div>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm whitespace-nowrap">
                    <span class="capitalize bg-gray-100 px-2 py-1 rounded text-xs text-gray-600 border border-gray-200">
                        ${user.role.replace("_", " ")}
                    </span>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm whitespace-nowrap">
                    <span class="relative inline-block px-3 py-1 font-semibold leading-tight ${isActive ? "text-green-900" : "text-red-900"}">
                        <span aria-hidden class="absolute inset-0 ${isActive ? "bg-green-200" : "bg-red-200"} opacity-50 rounded-full"></span>
                        <span class="relative text-xs">${isActive ? "Active" : "Banned"}</span>
                    </span>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm whitespace-nowrap">
                    <p class="text-gray-900">${new Date(user.createdAt).toLocaleDateString()}</p>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-right whitespace-nowrap">
                    <button onclick="toggleUser('${user._id}')" 
                        class="${isActive ? "text-red-600 bg-red-50 hover:bg-red-100 border-red-100" : "text-green-600 bg-green-50 hover:bg-green-100 border-green-100"} p-2 rounded mr-1 transition border" 
                        title="${isActive ? "Deactivate" : "Activate"}">
                        <i class="fas ${isActive ? "fa-ban" : "fa-check-circle"}"></i>
                    </button>
                    <button onclick="deleteUser('${user._id}')" class="text-gray-400 hover:text-red-600 p-2 transition" title="Delete Account">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
          `;
        });
        renderPagination(data.pagination);
      } else {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-gray-500">No users found</td></tr>';
        document.getElementById("pagination-controls").innerHTML = '';
      }
    } catch (error) {
      console.error(error);
      document.getElementById("users-table-body").innerHTML = '<tr><td colspan="5" class="text-center py-10 text-red-500">Error loading data</td></tr>';
    }
  }

  async function toggleUser(id) {
    if (!confirm("Change user account status?")) return;
    try {
        const res = await fetch(`/api/admin/users/${id}/toggle-status`, {
          method: "PUT",
          headers: { Authorization: `Bearer ${token}` },
        });
        if (res.ok) loadUsers(currentPage);
        else alert("Failed to update status");
    } catch(e) { console.error(e); }
  }

  async function deleteUser(id) {
    if (!confirm("Permanently delete this user? This action cannot be undone.")) return;
    try {
        const res = await fetch(`/api/admin/users/${id}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${token}` },
        });
        if (res.ok) loadUsers(currentPage);
        else alert("Failed to delete user");
    } catch(e) { console.error(e); }
  }

  function renderPagination(pagination) {
    const div = document.getElementById("pagination-controls");
    div.innerHTML = `
        <span class="text-xs text-gray-900 mb-2 xs:mb-0">
            Page ${pagination.current} of ${pagination.pages}
        </span>
        <div class="inline-flex xs:mt-0">
            <button ${pagination.current === 1 ? "disabled" : ""} 
                onclick="loadUsers(${pagination.current - 1})" 
                class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-l border border-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition">
                Prev
            </button>
            <button ${pagination.current === pagination.pages ? "disabled" : ""} 
                onclick="loadUsers(${pagination.current + 1})" 
                class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-r border border-gray-300 border-l-0 disabled:opacity-50 disabled:cursor-not-allowed transition">
                Next
            </button>
        </div>
    `;
  }
</script>