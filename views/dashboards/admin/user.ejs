<%- include('../../partials/header') %>

<div class="container mx-auto px-4 py-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">Manage Users</h1>
    <div class="flex gap-2">
      <select id="roleFilter" onchange="loadUsers()" class="border p-2 rounded">
        <option value="">All Roles</option>
        <option value="user">User</option>
        <option value="club_owner">Club Owner</option>
        <option value="admin">Admin</option>
      </select>
      <input
        type="text"
        id="searchUser"
        placeholder="Search by name or email..."
        class="border p-2 rounded w-64" />
      <button
        onclick="loadUsers()"
        class="bg-blue-600 text-white px-4 py-2 rounded">
        Search
      </button>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow overflow-hidden border">
    <table class="min-w-full leading-normal">
      <thead>
        <tr>
          <th
            class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">
            User
          </th>
          <th
            class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">
            Role
          </th>
          <th
            class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">
            Status
          </th>
          <th
            class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">
            Joined
          </th>
          <th
            class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase">
            Actions
          </th>
        </tr>
      </thead>
      <tbody id="users-table-body"></tbody>
    </table>

    <div
      class="px-5 py-5 bg-white border-t flex items-center justify-between"
      id="pagination-controls"></div>
  </div>
</div>

<script>
  const token = localStorage.getItem("token");
  let currentPage = 1;

  document.addEventListener("DOMContentLoaded", () => loadUsers());

  async function loadUsers(page = 1) {
    currentPage = page;
    const role = document.getElementById("roleFilter").value;
    const search = document.getElementById("searchUser").value;

    let query = `?page=${page}&limit=10`;
    if (role) query += `&role=${role}`;
    if (search) query += `&search=${search}`;

    try {
      const res = await fetch(`/api/admin/users/data${query}`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();

      const tbody = document.getElementById("users-table-body");
      tbody.innerHTML = "";

      if (data.users && data.users.length > 0) {
        data.users.forEach((user) => {
          const isActive = user.isActive;

          tbody.innerHTML += `
                        <tr>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 w-10 h-10">
                                        <img class="w-full h-full rounded-full object-cover" src="${
                                          user.profilePicture ||
                                          "https://via.placeholder.com/40"
                                        }" alt="" />
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-gray-900 whitespace-no-wrap font-bold">${
                                          user.firstName
                                        } ${user.lastName}</p>
                                        <p class="text-gray-500 text-xs">${
                                          user.email
                                        }</p>
                                    </div>
                                </div>
                            </td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                <span class="capitalize bg-gray-100 px-2 py-1 rounded text-xs text-gray-600 border">
                                    ${user.role.replace("_", " ")}
                                </span>
                            </td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                <span class="relative inline-block px-3 py-1 font-semibold leading-tight ${
                                  isActive ? "text-green-900" : "text-red-900"
                                }">
                                    <span aria-hidden class="absolute inset-0 ${
                                      isActive ? "bg-green-200" : "bg-red-200"
                                    } opacity-50 rounded-full"></span>
                                    <span class="relative">${
                                      isActive ? "Active" : "Banned"
                                    }</span>
                                </span>
                            </td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                <p class="text-gray-900 whitespace-no-wrap">${new Date(
                                  user.createdAt
                                ).toLocaleDateString()}</p>
                            </td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-right">
                                <button onclick="toggleUser('${
                                  user._id
                                }')" class="${
            isActive
              ? "text-red-500 bg-red-50 hover:bg-red-100"
              : "text-green-500 bg-green-50 hover:bg-green-100"
          } p-2 rounded mr-1 transition" title="${
            isActive ? "Deactivate" : "Activate"
          }">
                                    <i class="fas ${
                                      isActive ? "fa-ban" : "fa-check-circle"
                                    }"></i>
                                </button>
                                <button onclick="deleteUser('${
                                  user._id
                                }')" class="text-gray-400 hover:text-red-600 p-2" title="Delete Account">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
        });
        renderPagination(data.pagination);
      } else {
        tbody.innerHTML =
          '<tr><td colspan="5" class="text-center py-10 text-gray-500">No users found</td></tr>';
      }
    } catch (error) {
      console.error(error);
    }
  }

  async function toggleUser(id) {
    if (!confirm("Change user account status?")) return;
    const res = await fetch(`/api/admin/users/${id}/toggle-status`, {
      method: "PUT",
      headers: { Authorization: `Bearer ${token}` },
    });
    if (res.ok) loadUsers(currentPage);
  }

  async function deleteUser(id) {
    if (!confirm("Permanently delete this user? This action cannot be undone."))
      return;
    const res = await fetch(`/api/admin/users/${id}`, {
      method: "DELETE",
      headers: { Authorization: `Bearer ${token}` },
    });
    if (res.ok) loadUsers(currentPage);
    else alert("Failed to delete user");
  }

  function renderPagination(pagination) {
    const div = document.getElementById("pagination-controls");
    div.innerHTML = `
            <span class="text-xs text-gray-900">
                Page ${pagination.current} of ${pagination.pages}
            </span>
            <div class="inline-flex mt-2 xs:mt-0">
                <button ${
                  pagination.current === 1 ? "disabled" : ""
                } onclick="loadUsers(${
      pagination.current - 1
    })" class="text-sm bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-l disabled:opacity-50">Prev</button>
                <button ${
                  pagination.current === pagination.pages ? "disabled" : ""
                } onclick="loadUsers(${
      pagination.current + 1
    })" class="text-sm bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-r disabled:opacity-50">Next</button>
            </div>
        `;
  }
</script>

<%- include('../../partials/footer') %>
